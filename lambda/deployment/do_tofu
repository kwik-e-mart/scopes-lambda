#!/bin/bash
set -euo pipefail

TOFU_ACTION="${TOFU_ACTION:-apply}"

echo "ðŸ“ Running tofu $TOFU_ACTION for deployment: $DEPLOYMENT_ID"
echo "ðŸ“‹ Lambda function: $LAMBDA_FUNCTION_NAME"

echo "ðŸ“‹ Working directory: $TF_WORKING_DIR"

# Verify working directory has terraform files
if [ ! -d "$TF_WORKING_DIR" ]; then
  echo "âŒ Working directory does not exist: $TF_WORKING_DIR"
  exit 1
fi

tf_file_count=$(ls "$TF_WORKING_DIR"/*.tf 2>/dev/null | wc -l | tr -d ' ')
if [ "$tf_file_count" -eq 0 ]; then
  echo "âŒ No .tf files found in $TF_WORKING_DIR"
  echo "   Did you run compose_modules first?"
  exit 1
fi

echo "ðŸ“‹ Found $tf_file_count .tf files"

# Generate tfvars from TOFU_VARIABLES
TOFU_VAR_FILE="$OUTPUT_DIR/tofu.tfvars.json"
echo "$TOFU_VARIABLES" > "$TOFU_VAR_FILE"

# Copy scripts if they exist
if [ -d "$SERVICE_PATH/deployment/scripts" ]; then
  cp -r "$SERVICE_PATH/deployment/scripts" "$TF_WORKING_DIR/" 2>/dev/null || true
fi

# Initialize tofu
echo "ðŸ“ Initializing tofu..."
tofu -chdir="$TF_WORKING_DIR" init -input=false $TOFU_INIT_VARIABLES

# Run tofu action
echo "ðŸ“ Running tofu $TOFU_ACTION..."
tofu -chdir="$TF_WORKING_DIR" "$TOFU_ACTION" -auto-approve -var-file="$TOFU_VAR_FILE"

echo "âœ… Tofu $TOFU_ACTION completed successfully"

# Extract outputs if apply
if [ "$TOFU_ACTION" = "apply" ]; then
  echo ""
  echo "ðŸ“‹ Extracting terraform outputs..."

  # Get outputs as JSON
  outputs=$(tofu -chdir="$TF_WORKING_DIR" output -json 2>/dev/null || echo "{}")

  # Extract key values for export
  if [ "$outputs" != "{}" ]; then
    LAMBDA_FUNCTION_ARN=$(echo "$outputs" | jq -r '.lambda_function_arn.value // empty')
    LAMBDA_CURRENT_VERSION=$(echo "$outputs" | jq -r '.lambda_current_version.value // empty')
    API_GATEWAY_ID=$(echo "$outputs" | jq -r '.api_gateway_id.value // empty')
    API_GATEWAY_ENDPOINT=$(echo "$outputs" | jq -r '.api_gateway_endpoint.value // empty')

    if [ -n "$LAMBDA_FUNCTION_ARN" ]; then
      echo "   âœ… function_arn=$LAMBDA_FUNCTION_ARN"
      export LAMBDA_FUNCTION_ARN
    fi

    if [ -n "$LAMBDA_CURRENT_VERSION" ]; then
      echo "   âœ… version=$LAMBDA_CURRENT_VERSION"
      export LAMBDA_CURRENT_VERSION
    fi

    if [ -n "$API_GATEWAY_ID" ]; then
      echo "   âœ… api_gateway_id=$API_GATEWAY_ID"
      export API_GATEWAY_ID
    fi

    if [ -n "$API_GATEWAY_ENDPOINT" ]; then
      echo "   âœ… api_gateway_endpoint=$API_GATEWAY_ENDPOINT"
      export API_GATEWAY_ENDPOINT
    fi
  fi
fi
