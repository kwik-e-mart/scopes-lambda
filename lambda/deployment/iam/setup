#!/bin/bash

echo "üîç Validating IAM configuration..."

# Check if dedicated role is enabled via NRN
scope_nrn=$(echo "$CONTEXT" | jq -r '.scope.nrn')

echo "   üì° Checking IAM role configuration from NRN..."

# Try to get IAM configuration from NRN
use_dedicated_role="false"
role_name_template=""
role_policies="[]"
role_entity="scope"
existing_role_arn=""
existing_role_name=""
execution_role_arn=""

# Read NRN configuration for IAM
nrn_output=$(np nrn read --nrn "$scope_nrn" --ids "lambda.aws_lambda_use_dedicated_role,lambda.aws_lambda_dedicated_role_name_template,lambda.aws_lambda_dedicated_role_policies,lambda.aws_lambda_dedicated_role_entity,lambda.aws_dedicated_role_arn,lambda.aws_dedicated_role_name" --format json 2>&1)
echo "NRN: $nrn_output"

nrn_exit_code=$?

if [ $nrn_exit_code -eq 0 ]; then
  use_dedicated_role=$(echo "$nrn_output" | jq -r '.namespaces.lambda.aws_lambda_use_dedicated_role // "false"')
  role_name_template=$(echo "$nrn_output" | jq -r '.namespaces.lambda.aws_lambda_dedicated_role_name_template // ""')
  role_policies=$(echo "$nrn_output" | jq -r '.namespaces.lambda.aws_lambda_dedicated_role_policies // "[]"')
  role_entity=$(echo "$nrn_output" | jq -r '.namespaces.lambda.aws_lambda_dedicated_role_entity // "scope"')
  existing_role_arn=$(echo "$nrn_output" | jq -r '.namespaces.lambda.aws_dedicated_role_arn // ""')
  existing_role_name=$(echo "$nrn_output" | jq -r '.namespaces.lambda.aws_dedicated_role_name // ""')
  execution_role_arn=$(echo "$nrn_output" | jq -r '.namespaces.lambda.aws_lambda_execution_role_arn // ""')
fi

echo "   ‚úÖ use_dedicated_role=$use_dedicated_role"
echo "   ‚úÖ role_entity=$role_entity"

# If not using dedicated role, check for existing role ARN in context
if [ "$use_dedicated_role" != "true" ]; then
  lambda_role_arn=$execution_role_arn

  if [ -z "$lambda_role_arn" ] || [ "$lambda_role_arn" = "null" ]; then
    lambda_role_arn=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].lambda.execution_role_arn // empty')
  fi

  if [ -z "$lambda_role_arn" ] || [ "$lambda_role_arn" = "null" ]; then
    echo ""
    echo "   ‚ùå No Lambda execution role configured"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ Dedicated role is not enabled and no default role is configured"
    echo ""
    echo "  üîß How to fix:"
    echo "    ‚Ä¢ Enable dedicated roles via NRN configuration"
    echo "    ‚Ä¢ Or configure lambda.execution_role_arn in the cloud-provider"
    echo ""
    return 1
  fi

  echo "   ‚úÖ Using existing role: $lambda_role_arn"

  # Add role ARN to TOFU_VARIABLES without creating IAM resources
  TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
    --arg role_arn "$lambda_role_arn" \
    '. + {lambda_role_arn: $role_arn, iam_create_role: false}')

  echo ""
  echo "‚ú® IAM configured (using existing role)"
  echo ""
  return 0 2>/dev/null || return 0
fi

# Using dedicated role - validate required fields
if [ -z "$role_name_template" ] || [ "$role_name_template" = "null" ] || [ "$role_name_template" = "" ]; then
  echo ""
  echo "   ‚ùå Role name template not configured"
  echo ""
  echo "  üîß How to fix:"
  echo "    Set AWS_LAMBDA_DEDICATED_ROLE_NAME_TEMPLATE in NRN configuration"
  echo ""
  return 1
fi

if [ "$role_policies" = "[]" ] || [ "$role_policies" = "null" ]; then
  echo ""
  echo "   ‚ùå Role policies not configured"
  echo ""
  echo "  üîß How to fix:"
  echo "    Set AWS_LAMBDA_DEDICATED_ROLE_POLICIES in NRN configuration"
  echo ""
  return 1
fi

echo "   ‚úÖ role_name_template=$role_name_template"

# Generate role name from template
scope_id=$(echo "$CONTEXT" | jq -r '.scope.id')
scope_slug=$(echo "$CONTEXT" | jq -r '.scope.slug')
namespace_slug=$(echo "$CONTEXT" | jq -r '.namespace.slug')
application_slug=$(echo "$CONTEXT" | jq -r '.application.slug')
account_slug=$(echo "$CONTEXT" | jq -r '.account.slug')
deployment_id=$(echo "$CONTEXT" | jq -r '.deployment.id // ""')

# Replace template variables
iam_role_name="$role_name_template"
iam_role_name="${iam_role_name//\{scope_id\}/$scope_id}"
iam_role_name="${iam_role_name//\{scope_slug\}/$scope_slug}"
iam_role_name="${iam_role_name//\{namespace_slug\}/$namespace_slug}"
iam_role_name="${iam_role_name//\{application_slug\}/$application_slug}"
iam_role_name="${iam_role_name//\{account_slug\}/$account_slug}"
iam_role_name="${iam_role_name//\{deployment_id\}/$deployment_id}"

# Truncate to 64 chars (AWS IAM role name limit)
iam_role_name="${iam_role_name:0:64}"

echo "   ‚úÖ iam_role_name=$iam_role_name"

# Check if role already exists
if [ -n "$existing_role_arn" ] && [ "$existing_role_arn" != "null" ] && [ "$existing_role_arn" != "" ]; then
  echo "   ‚úÖ Using existing dedicated role: $existing_role_arn"

  TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
    --arg role_arn "$existing_role_arn" \
    --arg role_name "$existing_role_name" \
    '. + {
      lambda_role_arn: $role_arn,
      iam_role_name: $role_name,
      iam_create_role: false
    }')
else
  echo "   üìù Will create new IAM role"

  # Parse policies JSON
  policies_json="$role_policies"

  # Determine if VPC access is needed
  vpc_enabled=$(echo "$CONTEXT" | jq -r '.scope.capabilities.vpc_enabled // false')

  TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
    --arg role_name "$iam_role_name" \
    --argjson policies "$policies_json" \
    --argjson vpc_enabled "$vpc_enabled" \
    --arg role_entity "$role_entity" \
    '. + {
      iam_role_name: $role_name,
      iam_create_role: true,
      iam_role_policies: $policies,
      iam_vpc_enabled: $vpc_enabled,
      iam_role_entity: $role_entity
    }')
fi

echo ""
echo "‚ú® IAM configured successfully"
echo ""

# Add module to composition list
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir}/modules"

if [[ -n $MODULES_TO_USE ]]; then
  MODULES_TO_USE="$MODULES_TO_USE,$module_name"
else
  MODULES_TO_USE="$module_name"
fi
