#!/bin/bash
# Rollback IAM policies for a failed deployment
# This script removes deployment-specific policies from a role

echo "ðŸ“ Rolling back IAM policies..."

if [ -z "${LAMBDA_ROLE_NAME:-}" ]; then
  echo "âŒ LAMBDA_ROLE_NAME is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Environment variable not set by the deployment pipeline" >&2
  echo "   - Lambda execution role was not created during scope provisioning" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Verify the scope has a valid IAM role configured" >&2
  echo "   - Check that LAMBDA_ROLE_NAME is exported before this script runs" >&2
  return 1
fi

if [ -z "${DEPLOYMENT_ID:-}" ]; then
  echo "âŒ DEPLOYMENT_ID is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Deployment context not properly initialized" >&2
  echo "   - Script invoked outside of a deployment pipeline" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure this script is called from within a nullplatform deployment flow" >&2
  echo "   - Check that DEPLOYMENT_ID is set in the environment" >&2
  return 1
fi

if [ -z "${SCOPE_NRN:-}" ]; then
  echo "âŒ SCOPE_NRN is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Scope context not available in the environment" >&2
  echo "   - NRN not passed from the deployment pipeline" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Verify SCOPE_NRN is exported before this script runs" >&2
  echo "   - Check the deployment agent configuration" >&2
  return 1
fi

echo "   âœ… role_name=$LAMBDA_ROLE_NAME"
echo "   âœ… deployment_id=$DEPLOYMENT_ID"

deployment_nrn="${SCOPE_NRN}:deployment=${DEPLOYMENT_ID}"
echo "   ðŸ“¡ Reading merged policies from NRN=$deployment_nrn..."

nrn_output=$(np nrn read --nrn "$deployment_nrn" --namespace aws --format json 2>&1 || echo "{}")
policies=$(echo "$nrn_output" | jq -r '.AWS_LAMBDA_MERGED_POLICIES // "[]"')

if [ "$policies" = "[]" ] || [ "$policies" = "null" ]; then
  echo "   â­ï¸  No policies to rollback"
  return 0
fi

policy_count=$(echo "$policies" | jq length)
echo "   ðŸ“‹ Found $policy_count policies to remove from role=$LAMBDA_ROLE_NAME"

for i in $(seq 0 $((policy_count - 1))); do
  policy_name=$(echo "$policies" | jq -r ".[$i].name")
  full_policy_name="${policy_name}-${DEPLOYMENT_ID}"

  echo "   ðŸ“ Removing policy: $full_policy_name from role=$LAMBDA_ROLE_NAME"

  aws iam delete-role-policy \
    --role-name "$LAMBDA_ROLE_NAME" \
    --policy-name "$full_policy_name" 2>/dev/null || true

  echo "   âœ… Policy $full_policy_name removed"
done

echo ""
echo "âœ¨ IAM policies rolled back successfully for role=$LAMBDA_ROLE_NAME deployment=$DEPLOYMENT_ID"
