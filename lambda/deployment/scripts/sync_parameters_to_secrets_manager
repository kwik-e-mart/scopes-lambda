#!/bin/bash
# Sync parameters from CONTEXT to AWS Secrets Manager
# Called during deployment when PARAMETERS_STRATEGY=secretsmanager

source "$SERVICE_PATH/utils/log"

log info "ðŸ” Syncing parameters to Secrets Manager..."

# Skip if strategy is not secretsmanager
if [ "${PARAMETERS_STRATEGY:-env}" != "secretsmanager" ]; then
  log debug "   âœ… Parameters strategy is '${PARAMETERS_STRATEGY:-env}' - skipping Secrets Manager sync"
  return 0
fi

# Validate required variables
if [ -z "${SCOPE_ID:-}" ]; then
  echo "âŒ SCOPE_ID is not set" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - build_context did not run before this script" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure build_context runs before sync_parameters_to_secrets_manager" >&2
  return 1
fi

if [ -z "${CONTEXT:-}" ]; then
  echo "âŒ CONTEXT is not set" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - build_context did not export CONTEXT" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure build_context exports CONTEXT before this script runs" >&2
  return 1
fi

SECRET_NAME="nullplatform/${SCOPE_ID}/parameters"
log debug "   âœ… secret_name=$SECRET_NAME"

# Build single JSON object from parameters
PARAMETERS_JSON=$(echo "$CONTEXT" | jq -c '
  [.parameters.results // [] | .[] | {(.name): .value}] | add // {}
')

PARAM_COUNT=$(echo "$PARAMETERS_JSON" | jq 'length')
log debug "   âœ… parameters_count=$PARAM_COUNT"

if [ "$PARAM_COUNT" -eq 0 ]; then
  log warn "   âš ï¸ No parameters to sync - creating empty secret"
  PARAMETERS_JSON="{}"
fi

# Try to update existing secret first
echo ""
log info "   ðŸ“¡ Writing parameters to Secrets Manager..."

update_output=$(aws secretsmanager put-secret-value \
  --secret-id "$SECRET_NAME" \
  --secret-string "$PARAMETERS_JSON" \
  2>&1)
update_exit_code=$?

if [ $update_exit_code -ne 0 ]; then
  # Secret doesn't exist yet - create it
  if echo "$update_output" | grep -q "ResourceNotFoundException"; then
    log info "   ðŸ“ Secret not found - creating new secret..."

    # Build tags argument
    tags_arg="[]"
    if [ -n "${RESOURCE_TAGS_JSON:-}" ]; then
      tags_arg=$(echo "$RESOURCE_TAGS_JSON" | jq '[to_entries[] | {Key: .key, Value: .value}]')
    fi

    create_output=$(aws secretsmanager create-secret \
      --name "$SECRET_NAME" \
      --description "nullplatform parameters for scope ${SCOPE_ID}" \
      --secret-string "$PARAMETERS_JSON" \
      --tags "$tags_arg" \
      2>&1)
    create_exit_code=$?

    if [ $create_exit_code -ne 0 ]; then
      echo "âŒ Failed to create Secrets Manager secret '$SECRET_NAME'" >&2
      echo "ðŸ’¡ Possible causes:" >&2
      echo "   - Insufficient permissions to create secrets" >&2
      echo "   - Secret name conflicts with a deleted secret pending recovery" >&2
      echo "ðŸ”§ How to fix:" >&2
      echo "   - Verify the agent has secretsmanager:CreateSecret permission" >&2
      echo "   - Check if a deleted secret exists: aws secretsmanager list-secrets --filters Key=name,Values=$SECRET_NAME" >&2
      echo "   - AWS error: $create_output" >&2
      return 1
    fi

    log debug "   âœ… Secret created: $SECRET_NAME"
  else
    echo "âŒ Failed to update Secrets Manager secret '$SECRET_NAME'" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Insufficient permissions to update secrets" >&2
    echo "   - Secret is in a different region" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Verify the agent has secretsmanager:PutSecretValue permission" >&2
    echo "   - AWS error: $update_output" >&2
    return 1
  fi
else
  log debug "   âœ… Secret updated: $SECRET_NAME"
fi

echo ""
log info "âœ¨ Parameters synced to Secrets Manager ($PARAM_COUNT parameters)"
