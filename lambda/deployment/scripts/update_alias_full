#!/bin/bash
# Update Lambda alias to point to a single version (100% traffic)
# Used during finalization to complete a deployment

echo "ðŸ“ Finalizing traffic to new version..."

if [ -z "${LAMBDA_FUNCTION_NAME:-}" ]; then
  echo "âŒ LAMBDA_FUNCTION_NAME is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Environment variable not set by the deployment pipeline" >&2
  echo "   - Scope context missing Lambda function configuration" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure the scope has a valid Lambda function configured" >&2
  echo "   - Check that LAMBDA_FUNCTION_NAME is exported before this script runs" >&2
  return 1
fi

alias_name="${LAMBDA_MAIN_ALIAS_NAME:-main}"
new_version="${LAMBDA_NEW_VERSION:-$LAMBDA_CURRENT_VERSION}"

if [ -z "$new_version" ]; then
  echo "âŒ No version specified - both LAMBDA_NEW_VERSION and LAMBDA_CURRENT_VERSION are empty" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Deployment did not publish a new Lambda version" >&2
  echo "   - NRN metadata is missing version information" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure the build step publishes a new Lambda version" >&2
  echo "   - Check that LAMBDA_NEW_VERSION or LAMBDA_CURRENT_VERSION is set" >&2
  return 1
fi

echo "   âœ… function_name=$LAMBDA_FUNCTION_NAME"
echo "   âœ… alias=$alias_name"
echo "   âœ… new_version=$new_version"

echo ""
echo "   ðŸ“ Updating alias $alias_name to point to version $new_version on function $LAMBDA_FUNCTION_NAME..."

update_output=$(aws lambda update-alias \
  --function-name "$LAMBDA_FUNCTION_NAME" \
  --name "$alias_name" \
  --function-version "$new_version" \
  --routing-config '{}' 2>&1)
update_exit_code=$?

if [ $update_exit_code -ne 0 ]; then
  echo "âŒ Failed to update alias $alias_name to version $new_version on function $LAMBDA_FUNCTION_NAME" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Version $new_version does not exist on function $LAMBDA_FUNCTION_NAME" >&2
  echo "   - Alias $alias_name does not exist" >&2
  echo "   - Insufficient Lambda permissions" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Check if the version exists: aws lambda get-function --function-name $LAMBDA_FUNCTION_NAME --qualifier $new_version" >&2
  echo "   - Verify alias exists: aws lambda get-alias --function-name $LAMBDA_FUNCTION_NAME --name $alias_name" >&2
  echo "   ðŸ“‹ Error: $update_output" >&2
  return 1
fi

echo "   âœ… Alias $alias_name updated successfully to version $new_version"
echo ""
echo "âœ¨ Traffic finalized to version $new_version on function=$LAMBDA_FUNCTION_NAME alias=$alias_name"
