#!/bin/bash
# Cleanup old Lambda version after successful deployment finalization
# This removes the previous version to avoid accumulating unused versions

echo "ðŸ§¹ Cleaning up old Lambda version..."

if [ -z "${LAMBDA_FUNCTION_NAME:-}" ]; then
  echo "âŒ LAMBDA_FUNCTION_NAME is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Environment variable not set by the deployment pipeline" >&2
  echo "   - Scope context missing Lambda function configuration" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure the scope has a valid Lambda function configured" >&2
  echo "   - Check that LAMBDA_FUNCTION_NAME is exported before this script runs" >&2
  return 1
fi

old_version=""

if [ -n "${SCOPE_NRN:-}" ]; then
  nrn_output=$(np nrn read --nrn "$SCOPE_NRN" --ids "lambda.lambda_function_previous_version" --format json 2>&1 || echo "{}")
  old_version=$(echo "$nrn_output" | jq -r '.namespaces.lambda.lambda_function_previous_version // ""')
fi

if [ -z "$old_version" ] || [ "$old_version" = "null" ] || [ "$old_version" = "" ]; then
  echo "   â­ï¸  No previous version found to cleanup"
  return 0
fi

if [ "$old_version" = "\$LATEST" ] || [ "$old_version" = "1" ]; then
  echo "   â­ï¸  Skipping deletion of version $old_version (protected)"
  return 0
fi

echo "   âœ… function_name=$LAMBDA_FUNCTION_NAME"
echo "   âœ… old_version=$old_version"

echo ""
echo "   ðŸ“ Deleting Lambda version $old_version from function $LAMBDA_FUNCTION_NAME..."

aws lambda delete-function \
  --function-name "$LAMBDA_FUNCTION_NAME" \
  --qualifier "$old_version" \
  2>/dev/null || true

echo "   âœ… Old version $old_version cleanup complete"
echo ""
echo "âœ¨ Cleanup finished for function=$LAMBDA_FUNCTION_NAME version=$old_version"
