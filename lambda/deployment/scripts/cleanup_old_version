#!/bin/bash
# Cleanup old Lambda version after successful deployment finalization
# This removes the previous version to avoid accumulating unused versions

source "$SERVICE_PATH/utils/log"

log info "ðŸ§¹ Cleaning up old Lambda version..."

if [ -z "${LAMBDA_FUNCTION_NAME:-}" ]; then
  echo "âŒ LAMBDA_FUNCTION_NAME is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Environment variable not set by the deployment pipeline" >&2
  echo "   - Scope context missing Lambda function configuration" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure the scope has a valid Lambda function configured" >&2
  echo "   - Check that LAMBDA_FUNCTION_NAME is exported before this script runs" >&2
  return 1
fi

# Blue version = Lambda version of the previously active deployment (now superseded)
old_version="${LAMBDA_BLUE_VERSION:-}"

if [ -z "$old_version" ] || [ "$old_version" = "null" ] || [ "$old_version" = "" ]; then
  log info "   â­ï¸  No previous version found to cleanup"
  return 0
fi

if [ "$old_version" = "\$LATEST" ] || [ "$old_version" = "1" ]; then
  log info "   â­ï¸  Skipping deletion of version $old_version (protected)"
  return 0
fi

log debug "   âœ… function_name=$LAMBDA_FUNCTION_NAME"
log debug "   âœ… old_version=$old_version"

echo ""
log info "   ðŸ“ Deleting Lambda version $old_version from function $LAMBDA_FUNCTION_NAME..."

aws lambda delete-function \
  --function-name "$LAMBDA_FUNCTION_NAME" \
  --qualifier "$old_version" \
  2>/dev/null || true

log debug "   âœ… Old version $old_version cleanup complete"
echo ""
log info "âœ¨ Cleanup finished for function=$LAMBDA_FUNCTION_NAME version=$old_version"
