#!/bin/bash
# Cleanup new Lambda version after rollback
# This removes the failed version that was being deployed

source "$SERVICE_PATH/utils/log"

log info "ðŸ§¹ Cleaning up failed deployment version..."

if [ -z "${LAMBDA_FUNCTION_NAME:-}" ]; then
  echo "âŒ LAMBDA_FUNCTION_NAME is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Environment variable not set by the deployment pipeline" >&2
  echo "   - Scope context missing Lambda function configuration" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure the scope has a valid Lambda function configured" >&2
  echo "   - Check that LAMBDA_FUNCTION_NAME is exported before this script runs" >&2
  return 1
fi

new_version="${LAMBDA_GREEN_VERSION:-${LAMBDA_NEW_VERSION:-${LAMBDA_CURRENT_VERSION:-}}}"

if [ -z "$new_version" ] || [ "$new_version" = "null" ]; then
  log info "   â­ï¸  No new version specified to cleanup"
  return 0
fi

if [ "$new_version" = "\$LATEST" ]; then
  log info "   â­ï¸  Cannot delete \$LATEST"
  return 0
fi

log debug "   âœ… function_name=$LAMBDA_FUNCTION_NAME"
log debug "   âœ… new_version=$new_version"

echo ""
log info "   ðŸ“ Deleting failed version $new_version from function $LAMBDA_FUNCTION_NAME..."

aws lambda delete-function \
  --function-name "$LAMBDA_FUNCTION_NAME" \
  --qualifier "$new_version" \
  2>/dev/null || true

log debug "   âœ… Failed version $new_version cleanup complete"
echo ""
log info "âœ¨ Cleanup finished for function=$LAMBDA_FUNCTION_NAME version=$new_version"
