#!/bin/bash
# Store Lambda deployment metadata in NRN
# This script persists Lambda function details for future deployments

echo "ðŸ“ Storing deployment metadata in NRN..."

if [ -z "${SCOPE_NRN:-}" ]; then
  echo "âŒ SCOPE_NRN is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Scope context not available in the environment" >&2
  echo "   - NRN not passed from the deployment pipeline" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Verify SCOPE_NRN is exported before this script runs" >&2
  echo "   - Check the deployment agent configuration" >&2
  return 1
fi

if [ -z "${LAMBDA_FUNCTION_NAME:-}" ]; then
  echo "âŒ LAMBDA_FUNCTION_NAME is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Environment variable not set by the deployment pipeline" >&2
  echo "   - Scope context missing Lambda function configuration" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure the scope has a valid Lambda function configured" >&2
  echo "   - Check that LAMBDA_FUNCTION_NAME is exported before this script runs" >&2
  return 1
fi

echo "   âœ… scope_nrn=$SCOPE_NRN"
echo "   âœ… function_name=$LAMBDA_FUNCTION_NAME"

metadata="{}"

metadata=$(echo "$metadata" | jq \
  --arg fn "$LAMBDA_FUNCTION_NAME" \
  '. + {lambda_function_name: $fn}')

if [ -n "${LAMBDA_FUNCTION_ARN:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg arn "$LAMBDA_FUNCTION_ARN" \
    '. + {lambda_function_arn: $arn}')
  echo "   âœ… function_arn=$LAMBDA_FUNCTION_ARN"
fi

if [ -n "${LAMBDA_CURRENT_VERSION:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg ver "$LAMBDA_CURRENT_VERSION" \
    '. + {lambda_function_current_version: $ver}')
  echo "   âœ… current_version=$LAMBDA_CURRENT_VERSION"
fi

if [ -n "${LAMBDA_PREVIOUS_VERSION:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg ver "$LAMBDA_PREVIOUS_VERSION" \
    '. + {lambda_function_previous_version: $ver}')
  echo "   âœ… previous_version=$LAMBDA_PREVIOUS_VERSION"
fi

if [ -n "${LAMBDA_ALIAS_NAME:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg alias "$LAMBDA_ALIAS_NAME" \
    '. + {lambda_function_main_alias: $alias}')
  echo "   âœ… main_alias=$LAMBDA_ALIAS_NAME"
fi

if [ -n "${LAMBDA_ROLE_ARN:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg role "$LAMBDA_ROLE_ARN" \
    '. + {lambda_role_arn: $role}')
  echo "   âœ… role_arn=$LAMBDA_ROLE_ARN"
fi

if [ -n "${API_GATEWAY_ID:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg api "$API_GATEWAY_ID" \
    '. + {apigateway_http_api_id: $api}')
  echo "   âœ… api_gateway_id=$API_GATEWAY_ID"
fi

if [ -n "${SCOPE_DOMAIN:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg domain "$SCOPE_DOMAIN" \
    '. + {scope_domain: $domain}')
  echo "   âœ… scope_domain=$SCOPE_DOMAIN"
fi

if [ -n "${LAMBDA_CURRENT_RESERVED_CONCURRENCY_TYPE:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg val "$LAMBDA_CURRENT_RESERVED_CONCURRENCY_TYPE" \
    '. + {lambda_current_reserved_concurrency_type: $val}')
  echo "   âœ… reserved_concurrency_type=$LAMBDA_CURRENT_RESERVED_CONCURRENCY_TYPE"
fi

if [ -n "${LAMBDA_CURRENT_RESERVED_CONCURRENCY_VALUE:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg val "$LAMBDA_CURRENT_RESERVED_CONCURRENCY_VALUE" \
    '. + {lambda_current_reserved_concurrency_value: $val}')
  echo "   âœ… reserved_concurrency_value=$LAMBDA_CURRENT_RESERVED_CONCURRENCY_VALUE"
fi

if [ -n "${LAMBDA_CURRENT_PROVISIONED_CONCURRENCY_TYPE:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg val "$LAMBDA_CURRENT_PROVISIONED_CONCURRENCY_TYPE" \
    '. + {lambda_current_provisioned_concurrency_type: $val}')
  echo "   âœ… provisioned_concurrency_type=$LAMBDA_CURRENT_PROVISIONED_CONCURRENCY_TYPE"
fi

if [ -n "${LAMBDA_CURRENT_PROVISIONED_CONCURRENCY_VALUE:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg val "$LAMBDA_CURRENT_PROVISIONED_CONCURRENCY_VALUE" \
    '. + {lambda_current_provisioned_concurrency_value: $val}')
  echo "   âœ… provisioned_concurrency_value=$LAMBDA_CURRENT_PROVISIONED_CONCURRENCY_VALUE"
fi

if [ -n "${APIGATEWAY_HTTP_API_SCOPE_MAPPING_ID:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg val "$APIGATEWAY_HTTP_API_SCOPE_MAPPING_ID" \
    '. + {apigateway_http_api_scope_mapping_id: $val}')
  echo "   âœ… api_scope_mapping_id=$APIGATEWAY_HTTP_API_SCOPE_MAPPING_ID"
fi

if [ -n "${CURRENT_TARGET_GROUP_ARN:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg val "$CURRENT_TARGET_GROUP_ARN" \
    '. + {current_target_group_arn: $val}')
  echo "   âœ… target_group_arn=$CURRENT_TARGET_GROUP_ARN"
fi

if [ -n "${ALB_RULE_ARN:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg val "$ALB_RULE_ARN" \
    '. + {alb_rule_arn: $val}')
  echo "   âœ… alb_rule_arn=$ALB_RULE_ARN"
fi

if [ -n "${WARMUP_ALIAS_NAME:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg val "$WARMUP_ALIAS_NAME" \
    '. + {lambda_function_warm_alias: $val}')
  echo "   âœ… warm_alias=$WARMUP_ALIAS_NAME"
fi

echo ""
echo "   ðŸ“¡ Writing metadata to NRN=$SCOPE_NRN..."

# Prefix all keys with "lambda." namespace
metadata=$(echo "$metadata" | jq 'with_entries(.key = "lambda." + .key)')
echo "   âœ… Final metadata payload: $metadata"

np_output=$(np nrn patch \
  --nrn "$SCOPE_NRN" \
  --body "$metadata" \
  --format json 2>&1)
np_exit_code=$?

if [ $np_exit_code -ne 0 ]; then
  echo "âŒ Failed to write NRN metadata to scope=$SCOPE_NRN" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - NRN service is unreachable" >&2
  echo "   - Invalid metadata JSON payload" >&2
  echo "   - Insufficient permissions to write to NRN" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Check NRN service connectivity" >&2
  echo "   - Verify the metadata JSON is valid" >&2
  echo "   - Ensure the agent has write permissions to the NRN namespace" >&2
  echo "   ðŸ“‹ Error: $np_output" >&2
  return 1
fi

echo "   âœ… Metadata stored successfully"
echo ""
echo "âœ¨ NRN metadata saved for scope=$SCOPE_NRN function=$LAMBDA_FUNCTION_NAME"
