#!/bin/bash
# Wait for provisioned concurrency to be allocated
# This script polls Lambda until provisioned concurrency is READY

source "$SERVICE_PATH/utils/log"

log info "ðŸ” Checking provisioned concurrency status..."

provisioned_type=$(echo "$CONTEXT" | jq -r '.scope.capabilities.provisioned_concurrency.type // "unprovisioned"')

if [ "$provisioned_type" != "provisioned" ]; then
  log info "   â­ï¸  Provisioned concurrency not enabled (type=$provisioned_type) - skipping wait"
  return 0
fi

if [ -z "${LAMBDA_FUNCTION_NAME:-}" ]; then
  echo "âŒ LAMBDA_FUNCTION_NAME is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Environment variable not set by the deployment pipeline" >&2
  echo "   - Scope context missing Lambda function configuration" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure the scope has a valid Lambda function configured" >&2
  echo "   - Check that LAMBDA_FUNCTION_NAME is exported before this script runs" >&2
  return 1
fi

alias_name="${LAMBDA_MAIN_ALIAS_NAME:-main}"
max_wait="${PROVISIONED_CONCURRENCY_MAX_WAIT_SECONDS:-600}"
poll_interval="${PROVISIONED_CONCURRENCY_POLL_INTERVAL:-5}"

log debug "   âœ… function_name=$LAMBDA_FUNCTION_NAME"
log debug "   âœ… alias=$alias_name"
log debug "   âœ… max_wait=${max_wait}s"
log debug "   âœ… poll_interval=${poll_interval}s"

echo ""
log info "ðŸ“¡ Waiting for provisioned concurrency allocation on $LAMBDA_FUNCTION_NAME:$alias_name..."

start_time=$(date +%s)
last_status=""

while true; do
  current_time=$(date +%s)
  elapsed=$((current_time - start_time))

  if [ $elapsed -ge $max_wait ]; then
    echo "âŒ Timeout waiting for provisioned concurrency on $LAMBDA_FUNCTION_NAME:$alias_name (${elapsed}s/${max_wait}s elapsed)" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Insufficient Lambda concurrent execution limits in this region" >&2
    echo "   - AWS service issues or throttling" >&2
    echo "   - Requested concurrency too high for account limits" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Check account concurrency limits: aws lambda get-account-settings" >&2
    echo "   - Increase the timeout via PROVISIONED_CONCURRENCY_MAX_WAIT_SECONDS (current: ${max_wait}s)" >&2
    echo "   - Reduce the requested provisioned concurrency value" >&2
    echo "   - Check AWS Service Health Dashboard for Lambda issues" >&2
    return 1
  fi

  status_output=$(aws lambda get-provisioned-concurrency-config \
    --function-name "$LAMBDA_FUNCTION_NAME" \
    --qualifier "$alias_name" \
    2>&1 || echo "NOT_FOUND")

  if echo "$status_output" | grep -q "ProvisionedConcurrencyConfigNotFoundException\|NOT_FOUND"; then
    log info "   â­ï¸  No provisioned concurrency configuration found on $LAMBDA_FUNCTION_NAME:$alias_name - skipping"
    return 0
  fi

  status=$(echo "$status_output" | jq -r '.Status // "UNKNOWN"')
  requested=$(echo "$status_output" | jq -r '.RequestedProvisionedConcurrentExecutions // 0')
  allocated=$(echo "$status_output" | jq -r '.AllocatedProvisionedConcurrentExecutions // 0')

  if [ "$status" != "$last_status" ]; then
    log info "   ðŸ“‹ Status: $status (requested=$requested, allocated=$allocated) [${elapsed}s elapsed]"
    last_status="$status"
  fi

  case "$status" in
    "READY")
      echo ""
      log info "   âœ… Provisioned concurrency is READY on $LAMBDA_FUNCTION_NAME:$alias_name"
      log debug "   âœ… Allocated: $allocated instances"
      break
      ;;
    "IN_PROGRESS")
      # Continue waiting
      ;;
    "FAILED")
      status_reason=$(echo "$status_output" | jq -r '.StatusReason // "Unknown"')
      echo "âŒ Provisioned concurrency allocation FAILED on $LAMBDA_FUNCTION_NAME:$alias_name" >&2
      echo "ðŸ’¡ Possible causes:" >&2
      echo "   - $status_reason" >&2
      echo "   - Function code may have errors preventing initialization" >&2
      echo "ðŸ”§ How to fix:" >&2
      echo "   - Review the function logs for initialization errors" >&2
      echo "   - Verify the function can be invoked successfully" >&2
      echo "   - Check Lambda concurrent execution limits" >&2
      return 1
      ;;
    *)
      log warn "   âš ï¸  Unknown status: $status on $LAMBDA_FUNCTION_NAME:$alias_name"
      ;;
  esac

  sleep $poll_interval
done

if [ -n "${WARMUP_ALIAS_NAME:-}" ]; then
  echo ""
  log info "ðŸ“¡ Checking provisioned concurrency on warm alias $WARMUP_ALIAS_NAME..."

  warm_status_output=$(aws lambda get-provisioned-concurrency-config \
    --function-name "$LAMBDA_FUNCTION_NAME" \
    --qualifier "$WARMUP_ALIAS_NAME" \
    2>&1 || echo "NOT_FOUND")

  if echo "$warm_status_output" | grep -q "ProvisionedConcurrencyConfigNotFoundException\|NOT_FOUND"; then
    log info "   â­ï¸  No provisioned concurrency on warm alias $WARMUP_ALIAS_NAME - skipping"
  else
    warm_status=$(echo "$warm_status_output" | jq -r '.Status // "UNKNOWN"')
    warm_requested=$(echo "$warm_status_output" | jq -r '.RequestedProvisionedConcurrentExecutions // 0')
    warm_allocated=$(echo "$warm_status_output" | jq -r '.AllocatedProvisionedConcurrentExecutions // 0')

    log info "   ðŸ“‹ Warm alias status: $warm_status (requested=$warm_requested, allocated=$warm_allocated)"

    warm_start_time=$(date +%s)

    while [ "$warm_status" = "IN_PROGRESS" ]; do
      warm_current_time=$(date +%s)
      warm_elapsed=$((warm_current_time - warm_start_time))

      if [ $warm_elapsed -ge $max_wait ]; then
        echo "âŒ Timeout waiting for provisioned concurrency on warm alias $WARMUP_ALIAS_NAME (${warm_elapsed}s/${max_wait}s elapsed)" >&2
        echo "ðŸ’¡ Possible causes:" >&2
        echo "   - Insufficient Lambda concurrent execution limits" >&2
        echo "   - AWS service issues or throttling" >&2
        echo "ðŸ”§ How to fix:" >&2
        echo "   - Check account concurrency limits: aws lambda get-account-settings" >&2
        echo "   - Increase PROVISIONED_CONCURRENCY_MAX_WAIT_SECONDS (current: ${max_wait}s)" >&2
        return 1
      fi

      sleep $poll_interval

      warm_status_output=$(aws lambda get-provisioned-concurrency-config \
        --function-name "$LAMBDA_FUNCTION_NAME" \
        --qualifier "$WARMUP_ALIAS_NAME" \
        2>&1 || echo "NOT_FOUND")

      warm_status=$(echo "$warm_status_output" | jq -r '.Status // "UNKNOWN"')
      warm_allocated=$(echo "$warm_status_output" | jq -r '.AllocatedProvisionedConcurrentExecutions // 0')

      log info "   ðŸ“‹ Warm alias status: $warm_status (allocated=$warm_allocated) [${warm_elapsed}s elapsed]"
    done

    if [ "$warm_status" = "READY" ]; then
      log info "   âœ… Warm alias $WARMUP_ALIAS_NAME provisioned concurrency is READY (allocated=$warm_allocated)"
    elif [ "$warm_status" = "FAILED" ]; then
      warm_reason=$(echo "$warm_status_output" | jq -r '.StatusReason // "Unknown"')
      echo "âŒ Provisioned concurrency FAILED on warm alias $WARMUP_ALIAS_NAME" >&2
      echo "ðŸ’¡ Possible causes:" >&2
      echo "   - $warm_reason" >&2
      echo "ðŸ”§ How to fix:" >&2
      echo "   - Review the function logs for initialization errors" >&2
      echo "   - Verify warm alias $WARMUP_ALIAS_NAME points to a valid version" >&2
      return 1
    fi
  fi
fi

echo ""
log info "âœ¨ Provisioned concurrency allocation complete for function=$LAMBDA_FUNCTION_NAME"
