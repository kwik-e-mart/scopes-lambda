#!/bin/bash
# Rollback Lambda alias to previous version
# Used when a deployment needs to be rolled back

echo "ðŸ”„ Rolling back Lambda alias to previous version..."

if [ -z "${LAMBDA_FUNCTION_NAME:-}" ]; then
  echo "âŒ LAMBDA_FUNCTION_NAME is required" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Environment variable not set by the deployment pipeline" >&2
  echo "   - Scope context missing Lambda function configuration" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Ensure the scope has a valid Lambda function configured" >&2
  echo "   - Check that LAMBDA_FUNCTION_NAME is exported before this script runs" >&2
  exit 1
fi

alias_name="${LAMBDA_MAIN_ALIAS_NAME:-main}"

echo "   âœ… function_name=$LAMBDA_FUNCTION_NAME"
echo "   âœ… alias=$alias_name"

previous_version=""

if [ -n "${SCOPE_NRN:-}" ]; then
  nrn_output=$(np nrn read --nrn "$SCOPE_NRN" --namespace aws --format json 2>&1 || echo "{}")
  previous_version=$(echo "$nrn_output" | jq -r '.LAMBDA_FUNCTION_CURRENT_VERSION // ""')
fi

if [ -z "$previous_version" ] || [ "$previous_version" = "null" ] || [ "$previous_version" = "" ]; then
  echo "âŒ No previous version found to rollback to" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - This is the first deployment (no previous version exists)" >&2
  echo "   - NRN metadata was not stored properly for scope=$SCOPE_NRN" >&2
  echo "   - LAMBDA_FUNCTION_CURRENT_VERSION key is missing from NRN" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Verify NRN metadata: np nrn read --nrn $SCOPE_NRN --namespace aws --format json" >&2
  echo "   - Manually set the alias version if the previous version is known" >&2
  exit 1
fi

echo "   âœ… previous_version=$previous_version"

echo ""
echo "   ðŸ“ Updating alias $alias_name to point to version $previous_version on function $LAMBDA_FUNCTION_NAME..."

update_output=$(aws lambda update-alias \
  --function-name "$LAMBDA_FUNCTION_NAME" \
  --name "$alias_name" \
  --function-version "$previous_version" \
  --routing-config '{}' 2>&1)
update_exit_code=$?

if [ $update_exit_code -ne 0 ]; then
  echo "âŒ Failed to rollback alias $alias_name to version $previous_version on function $LAMBDA_FUNCTION_NAME" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Version $previous_version no longer exists" >&2
  echo "   - Alias $alias_name does not exist on function $LAMBDA_FUNCTION_NAME" >&2
  echo "   - Insufficient Lambda permissions" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Check if the version exists: aws lambda get-function --function-name $LAMBDA_FUNCTION_NAME --qualifier $previous_version" >&2
  echo "   - Verify alias exists: aws lambda get-alias --function-name $LAMBDA_FUNCTION_NAME --name $alias_name" >&2
  echo "   ðŸ“‹ Error: $update_output" >&2
  exit 1
fi

echo "   âœ… Alias $alias_name rolled back successfully to version $previous_version"
echo ""
echo "âœ¨ Rollback complete - traffic restored to version $previous_version on function=$LAMBDA_FUNCTION_NAME"
