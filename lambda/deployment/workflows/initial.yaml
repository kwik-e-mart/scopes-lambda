include:
  - "$SERVICE_PATH/values.yaml"
configuration:
  TOFU_ACTION: "apply"
steps:
  - name: build_context
    type: script
    file: "$SERVICE_PATH/deployment/build_context"
    output:
      - name: SCOPE_ID
        type: environment
      - name: DEPLOYMENT_ID
        type: environment
      - name: SCOPE_NRN
        type: environment
      - name: LAMBDA_FUNCTION_NAME
        type: environment
      - name: LAMBDA_CURRENT_VERSION
        type: environment
      - name: LAMBDA_GREEN_VERSION
        type: environment
      - name: LAMBDA_BLUE_VERSION
        type: environment
      - name: VISIBILITY
        type: environment
      - name: OUTPUT_DIR
        type: environment
      - name: TF_WORKING_DIR
        type: environment
      - name: TOFU_MODULE_DIR
        type: environment
      - name: TOFU_VARIABLES
        type: environment
      - name: TOFU_INIT_VARIABLES
        type: environment
      - name: MODULES_TO_USE
        type: environment
      - name: CONTEXT
        type: environment
      - name: RESOURCE_TAGS_JSON
        type: environment
  - name: sync_parameters_to_secrets_manager
    type: script
    file: "$SERVICE_PATH/deployment/scripts/sync_parameters_to_secrets_manager"
  - name: setup_provider
    type: script
    file: "$SERVICE_PATH/deployment/provider/aws/setup"
    output:
      - name: TOFU_VARIABLES
        type: environment
      - name: TOFU_INIT_VARIABLES
        type: environment
      - name: MODULES_TO_USE
        type: environment
  - name: setup_iam
    type: script
    file: "$SERVICE_PATH/deployment/iam/setup"
    output:
      - name: TOFU_VARIABLES
        type: environment
      - name: MODULES_TO_USE
        type: environment
      - name: CONTEXT
        type: environment
  - name: setup_compute
    type: script
    file: "$SERVICE_PATH/deployment/compute/lambda/setup"
    output:
      - name: TOFU_VARIABLES
        type: environment
      - name: MODULES_TO_USE
        type: environment
  - name: setup_dns
    type: script
    file: "$SERVICE_PATH/deployment/dns/route53/setup"
    output:
      - name: TOFU_VARIABLES
        type: environment
      - name: MODULES_TO_USE
        type: environment
  - name: setup_networking
    type: workflow
    steps:
      - name: setup_api_gateway
        type: script
        file: "$SERVICE_PATH/deployment/networking/api_gateway/setup"
        output:
          - name: TOFU_VARIABLES
            type: environment
          - name: MODULES_TO_USE
            type: environment
      - name: setup_alb
        type: script
        file: "$SERVICE_PATH/deployment/networking/alb/setup"
        output:
          - name: TOFU_VARIABLES
            type: environment
          - name: MODULES_TO_USE
            type: environment
          - name: ALB_RULE_PRIORITY
            type: environment
  - name: compose_modules
    type: script
    file: "$SERVICE_PATH/deployment/compose_modules"
  - name: tofu
    type: script
    file: "$SERVICE_PATH/deployment/do_tofu"
    output:
      - name: LAMBDA_FUNCTION_ARN
        type: environment
      - name: LAMBDA_CURRENT_VERSION
        type: environment
      - name: ALB_RULE_ARN
        type: environment
  - name: wait_provisioned_concurrency
    type: script
    file: "$SERVICE_PATH/deployment/scripts/wait_provisioned_concurrency"
  - name: store_metadata
    type: script
    file: "$SERVICE_PATH/deployment/scripts/store_nrn_metadata"
