#!/bin/bash

source "$SERVICE_PATH/utils/log"

log info "ðŸ” Validating ALB configuration..."

# Check visibility - ALB is only for private scopes
visibility=$(echo "$CONTEXT" | jq -r '.scope.capabilities.visibility // "public"')

if [ "$visibility" != "private" ] && [ "$visibility" != "internal" ]; then
  echo ""
  log info "   â­ï¸  Skipping ALB - visibility is '$visibility' (not private/internal)"
  echo ""
  # Include ALB stubs so Route53 module always has alb_dns_name / alb_zone_id locals declared
  alb_stubs="$SERVICE_PATH/deployment/dns/route53/stubs_no_alb"
  if [[ -n ${MODULES_TO_USE:-} ]]; then
    MODULES_TO_USE="$MODULES_TO_USE,$alb_stubs"
  else
    MODULES_TO_USE="$alb_stubs"
  fi
  return 0 2>/dev/null || return 0
fi

log debug "   âœ… visibility=$visibility"

# Get ALB listener ARN from context or environment
alb_listener_arn=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].alb.listener_arn // empty')

if [ -z "$alb_listener_arn" ] || [ "$alb_listener_arn" = "null" ]; then
  # Try environment variable as fallback
  alb_listener_arn="${ALB_LISTENER_ARN:-}"
fi

if [ -z "$alb_listener_arn" ]; then
  echo ""
  echo "   âŒ ALB listener ARN not found" >&2
  echo "" >&2
  echo "  ðŸ’¡ Possible causes:" >&2
  echo "    â€¢ ALB listener ARN not configured in cloud-provider" >&2
  echo "    â€¢ ALB_LISTENER_ARN environment variable not set" >&2
  echo "" >&2
  echo "  ðŸ”§ How to fix:" >&2
  echo "    â€¢ Configure alb.listener_arn in the cloud-provider settings" >&2
  echo "    â€¢ Or set ALB_LISTENER_ARN environment variable in Helm values" >&2
  echo "" >&2
  return 1
fi

log debug "   âœ… alb_listener_arn=$alb_listener_arn"

# Extract scope information for naming
scope_id=$(echo "$CONTEXT" | jq -r '.scope.id')
scope_slug=$(echo "$CONTEXT" | jq -r '.scope.slug')
application_slug=$(echo "$CONTEXT" | jq -r '.application.slug')
namespace_slug=$(echo "$CONTEXT" | jq -r '.namespace.slug')

# Target group name (max 32 chars for ALB)
# scope_id guarantees uniqueness; app+scope slugs are for human readability in AWS console
# Dashes removed from slugs to maximize readable chars within the 32-char limit
# Format: {scope_id}-{app_nodash:9}-{scope_nodash:9}
app_slug_nodash="${application_slug//-/}"
scope_slug_nodash="${scope_slug//-/}"
target_group_name="${scope_id}-${app_slug_nodash:0:9}-${scope_slug_nodash:0:9}"
target_group_name="${target_group_name:0:32}"
log debug "   âœ… target_group_name=$target_group_name"

# Host header for routing
# Prefer dns_full_domain from TOFU_VARIABLES (set by setup_dns which runs before setup_networking).
# Fall back to scope.domain from context (set on previous deployments), then a generated pattern.
host_header=$(echo "$TOFU_VARIABLES" | jq -r '.dns_full_domain // empty')
if [ -z "$host_header" ] || [ "$host_header" = "null" ]; then
  host_header=$(echo "$CONTEXT" | jq -r '.scope.domain // empty')
fi
if [ -z "$host_header" ] || [ "$host_header" = "null" ]; then
  host_header="${namespace_slug}-${application_slug}-${scope_slug}.internal"
fi
log debug "   âœ… host_header=$host_header"

# Rule priority - incremental assignment with NRN persistence
# 1. NRN (re-deployments are idempotent, no race condition)
# 2. Dynamic query to listener (first deployment; small race window, AWS rejects duplicates)
rule_priority=""

nrn_priority_output=$(np nrn read --nrn "$SCOPE_NRN" --ids "lambda.alb_rule_priority" --format json 2>/dev/null || echo "{}")
if [ "$nrn_priority_output" != "{}" ]; then
  rule_priority=$(echo "$nrn_priority_output" | jq -r '.namespaces.lambda.alb_rule_priority // empty')
fi

if [ -n "$rule_priority" ] && [ "$rule_priority" != "null" ]; then
  log debug "   âœ… rule_priority=$rule_priority (from NRN)"
else
  priority_start="${ALB_LISTENER_RULE_PRIORITY_START:-100}"
  log info "   ðŸ“¡ Querying listener for used priorities (range start: $priority_start)..."

  used_priorities_json=$(aws elbv2 describe-rules \
    --listener-arn "$alb_listener_arn" \
    --output json 2>/dev/null | jq '[.Rules[] | select(.Priority != "default") | .Priority | tonumber]')

  rule_priority="$priority_start"
  while echo "$used_priorities_json" | jq -e --argjson p "$rule_priority" 'contains([$p])' > /dev/null 2>&1; do
    rule_priority=$((rule_priority + 1))
  done

  log debug "   âœ… rule_priority=$rule_priority (auto-assigned)"
fi

ALB_RULE_PRIORITY="$rule_priority"
export ALB_RULE_PRIORITY

# Health check configuration
health_check_path=$(echo "$CONTEXT" | jq -r '.scope.capabilities.health_check.path // "/health"')
health_check_enabled="true"
if [ "$health_check_path" = "" ] || [ "$health_check_path" = "null" ]; then
  health_check_enabled="false"
  health_check_path="/health"
fi
log debug "   âœ… health_check_path=$health_check_path (enabled=$health_check_enabled)"

# Get Lambda information from context
lambda_function_name=$(echo "$CONTEXT" | jq -r '.lambda.function_name // empty')

if [ -z "$lambda_function_name" ]; then
  echo ""
  echo "   âŒ Lambda function name not found in context" >&2
  echo "" >&2
  return 1
fi

log debug "   âœ… lambda_function_name=$lambda_function_name"

RESOURCE_TAGS_JSON=${RESOURCE_TAGS_JSON:-"{}"}

TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
  --arg listener_arn "$alb_listener_arn" \
  --arg target_group_name "$target_group_name" \
  --arg host_header "$host_header" \
  --argjson priority "$rule_priority" \
  --arg health_check_path "$health_check_path" \
  --argjson health_check_enabled "$health_check_enabled" \
  --argjson resource_tags_json "$RESOURCE_TAGS_JSON" \
  '. + {
    alb_listener_arn: $listener_arn,
    alb_target_group_name: $target_group_name,
    alb_host_header: $host_header,
    alb_rule_priority: $priority,
    alb_health_check_path: $health_check_path,
    alb_health_check_enabled: $health_check_enabled,
    alb_resource_tags_json: $resource_tags_json
  }')

echo ""
log info "âœ¨ ALB configured successfully"
echo ""

# Add module to composition list
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir}/modules"

if [[ -n $MODULES_TO_USE ]]; then
  MODULES_TO_USE="$MODULES_TO_USE,$module_name"
else
  MODULES_TO_USE="$module_name"
fi
