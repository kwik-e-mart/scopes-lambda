#!/bin/bash

# Compose Terraform modules dynamically
# Usage: source compose_modules
#
# Required environment variables:
#   MODULES_TO_USE  - Comma-separated list of modules (e.g., "provider/aws,compute/lambda")
#   TOFU_MODULE_DIR - Target directory where .tf files will be copied
#
# Each module can have:
#   - *.tf files: Copied to TOFU_MODULE_DIR (Terraform auto-merges all .tf files)
#   - setup script: Sourced to configure TOFU_VARIABLES and TOFU_INIT_VARIABLES

source "$SERVICE_PATH/utils/log"

script_dir="$(dirname "${BASH_SOURCE[0]}")"
modules_dir="$script_dir"

log info "ðŸ” Validating module composition configuration..."

if [ -z "${MODULES_TO_USE:-}" ]; then
  echo ""
  echo "   âŒ MODULES_TO_USE is not set" >&2
  echo "" >&2
  echo "  ðŸ”§ How to fix:" >&2
  echo "    â€¢ Ensure MODULES_TO_USE is set before calling compose_modules" >&2
  echo "    â€¢ This is typically done by the setup scripts (provider, compute, networking)" >&2
  echo "" >&2
  return 1
fi

if [ -z "${TOFU_MODULE_DIR:-}" ]; then
  echo ""
  echo "   âŒ TOFU_MODULE_DIR is not set" >&2
  echo "" >&2
  echo "  ðŸ”§ How to fix:" >&2
  echo "    â€¢ Ensure TOFU_MODULE_DIR is set before calling compose_modules" >&2
  echo "    â€¢ This is typically done by the build_context script" >&2
  echo "" >&2
  return 1
fi

mkdir -p "$TOFU_MODULE_DIR"

log debug "   âœ… modules=$MODULES_TO_USE"
log debug "   âœ… target=$TOFU_MODULE_DIR"
echo ""

IFS=',' read -ra modules <<< "$MODULES_TO_USE"
for module in "${modules[@]}"; do
  module=$(echo "$module" | xargs) # trim whitespace

  if [ ! -d "$module" ]; then
    echo "   âŒ Module directory not found: $module" >&2
    echo "" >&2
    echo "  ðŸ”§ How to fix:" >&2
    echo "    â€¢ Verify the module path is correct and the directory exists" >&2
    echo "" >&2
    return 1
  fi

  log info "ðŸ“¦ $module"

  # Copy .tf files if they exist (with module prefix to avoid conflicts)
  if ls "$module"/*.tf 1> /dev/null 2>&1; then
    # Extract last two path components for prefix (e.g., "/path/to/compute/lambda" -> "compute_lambda_")
    parent=$(basename "$(dirname "$module")")
    leaf=$(basename "$module")
    prefix="${parent}_${leaf}_"

    copied_files=()
    for tf_file in "$module"/*.tf; do
      filename=$(basename "$tf_file")
      # Skip test-only files (test_*.tf)
      if [[ "$filename" == test_*.tf ]]; then
        continue
      fi
      cp "$tf_file" "$TOFU_MODULE_DIR/${prefix}${filename}"
      copied_files+=("$filename")
    done

    for file in "${copied_files[@]}"; do
      log debug "   $file"
    done
    log debug "   âœ… Copied ${#copied_files[@]} file(s) with prefix: $prefix"
  fi

  # Source setup script if it exists
  if [ -f "$module/setup" ]; then
    log info "   ðŸ“¡ Running setup script..."
    source "$module/setup"
    if [ $? -ne 0 ]; then
      echo ""
      echo "   âŒ Setup script failed for module: $module" >&2
      echo "" >&2
      return 1
    fi
    log debug "   âœ… Setup completed"
  fi

  echo ""
done

log info "âœ¨ All modules composed successfully"
