#!/bin/bash

echo "üîç Validating Route53 DNS configuration..."

# Get hosted zone ID from context
hosted_zone_id=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].networking.hosted_public_zone_id // empty')

if [ -z "$hosted_zone_id" ] || [ "$hosted_zone_id" = "null" ]; then
  echo ""
  echo "   ‚ùå hosted_public_zone_id is not set in context"
  echo ""
  echo "  üîß How to fix:"
  echo "    1. Ensure there is an AWS cloud-provider configured at the correct NRN hierarchy level"
  echo "    2. Set the 'hosted_public_zone_id' field with the Route 53 hosted zone ID"
  echo ""
  return 1
fi
echo "   ‚úÖ hosted_zone_id=$hosted_zone_id"

# Extract scope information
scope_id=$(echo "$CONTEXT" | jq -r '.scope.id')
scope_slug=$(echo "$CONTEXT" | jq -r '.scope.slug')
application_slug=$(echo "$CONTEXT" | jq -r '.application.slug')
namespace_slug=$(echo "$CONTEXT" | jq -r '.namespace.slug')
account_slug=$(echo "$CONTEXT" | jq -r '.account.slug')

echo ""
echo "   üì° Fetching domain from Route 53 hosted zone..."

aws_output=$(aws route53 get-hosted-zone --id "$hosted_zone_id" 2>&1)
aws_exit_code=$?

if [ $aws_exit_code -ne 0 ]; then
  echo ""
  echo "   ‚ùå Failed to fetch Route 53 hosted zone information"
  echo ""

  if echo "$aws_output" | grep -q "NoSuchHostedZone"; then
    echo "  üîé Error: Hosted zone '$hosted_zone_id' does not exist"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The hosted zone ID is incorrect or has a typo"
    echo "    ‚Ä¢ The hosted zone was deleted"
    echo ""
    echo "  üîß How to fix:"
    echo "    1. Verify the hosted zone exists: aws route53 list-hosted-zones"
    echo "    2. Update 'hosted_public_zone_id' in the AWS cloud-provider configuration"

  elif echo "$aws_output" | grep -q "AccessDenied\|not authorized"; then
    echo "  üîí Error: Permission denied when accessing Route 53"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The AWS credentials don't have Route 53 read permissions"
    echo ""
    echo "  üîß How to fix:"
    echo "    1. Ensure the IAM policy includes route53:GetHostedZone permission"

  else
    echo "  üìã Error details:"
    echo "$aws_output" | sed 's/^/    /'
  fi

  echo ""
  return 1
fi

network_domain=$(echo "$aws_output" | jq -r '.HostedZone.Name' | sed 's/\.$//')

if [ -z "$network_domain" ] || [ "$network_domain" = "null" ]; then
  echo ""
  echo "   ‚ùå Failed to extract domain name from hosted zone response"
  echo ""
  return 1
fi

echo "   ‚úÖ domain=$network_domain"

# Generate subdomain based on pattern
use_account_slug="${USE_ACCOUNT_SLUG:-true}"

if [ "$use_account_slug" = "true" ]; then
  network_subdomain="${namespace_slug}-${application_slug}-${scope_slug}.${account_slug}"
else
  network_subdomain="${namespace_slug}-${application_slug}-${scope_slug}"
fi

echo "   ‚úÖ subdomain=$network_subdomain"

# Full domain
scope_domain="${network_subdomain}.${network_domain}"
echo "   ‚úÖ full_domain=$scope_domain"

# Determine the DNS target based on visibility
visibility=$(echo "$CONTEXT" | jq -r '.scope.visibility // "public"')

# These will be set by the networking layer via terraform locals
# For API Gateway: api_gateway_target_domain, api_gateway_target_zone_id
# For ALB: the ALB domain from the listener

TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
  --arg hosted_zone_id "$hosted_zone_id" \
  --arg domain "$network_domain" \
  --arg subdomain "$network_subdomain" \
  --arg full_domain "$scope_domain" \
  '. + {
    dns_hosted_zone_id: $hosted_zone_id,
    dns_domain: $domain,
    dns_subdomain: $subdomain,
    dns_full_domain: $full_domain
  }')

# Configure API Gateway custom domain if API Gateway is being used
api_gateway_name=$(echo "$TOFU_VARIABLES" | jq -r '.api_gateway_name // empty')
if [ -n "$api_gateway_name" ]; then
  cert_arn=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].networking.certificate_arn // empty')

  if [ -n "$cert_arn" ] && [ "$cert_arn" != "null" ]; then
    echo "   ‚úÖ certificate_arn=$cert_arn"
    echo "   üìù Configuring API Gateway custom domain: $scope_domain"

    TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq \
      --arg domain "$scope_domain" \
      --arg cert "$cert_arn" \
      '. + {
        api_gateway_custom_domain: $domain,
        api_gateway_certificate_arn: $cert,
        dns_use_api_gateway_cname: false
      }')
  else
    echo "   ‚ö†Ô∏è  No certificate_arn in cloud-provider context - using CNAME to execute-api endpoint"
    TOFU_VARIABLES=$(echo "$TOFU_VARIABLES" | jq '. + {dns_use_api_gateway_cname: true}')
  fi
fi

echo ""
echo "   üìù Setting scope domain to '$scope_domain'..."

np_output=$(np scope patch --id "$scope_id" --body "{\"domain\":\"$scope_domain\"}" --format json 2>&1)
np_exit_code=$?

if [ $np_exit_code -ne 0 ]; then
  echo ""
  echo "   ‚ùå Failed to update scope domain"
  echo ""

  if echo "$np_output" | grep -q "unauthorized\|forbidden\|401\|403"; then
    echo "  üîí Error: Permission denied"
    echo ""
    echo "  üí° Possible causes:"
    echo "    ‚Ä¢ The nullplatform API Key doesn't have 'Developer' permissions"
    echo ""
  else
    echo "  üìã Error details:"
    echo "$np_output" | sed 's/^/    /'
  fi

  echo ""
  return 1
fi

echo "   ‚úÖ Scope domain set successfully"

echo ""
echo "‚ú® Route53 DNS configured successfully"
echo ""

# Add module to composition list
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
module_name="${script_dir}/modules"

if [[ -n $MODULES_TO_USE ]]; then
  MODULES_TO_USE="$MODULES_TO_USE,$module_name"
else
  MODULES_TO_USE="$module_name"
fi
