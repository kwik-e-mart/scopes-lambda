#!/bin/bash
# Generate domain for Lambda scope
# Based on k8s domain generation pattern

echo "ðŸ” Generating scope domain..."

# Get hosted zone ID from context
hosted_zone_id=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].networking.hosted_public_zone_id // empty')

if [ -z "$hosted_zone_id" ] || [ "$hosted_zone_id" = "null" ]; then
  echo "   âœ… No hosted_public_zone_id configured - skipping domain generation"
  SCOPE_DOMAIN=""
  export SCOPE_DOMAIN
  exit 0
fi

echo "   ðŸ“‹ hosted_zone_id=$hosted_zone_id"

# Get domain from Route53
echo ""
echo "   ðŸ“¡ Fetching domain from Route 53 hosted zone..."

aws_output=$(aws route53 get-hosted-zone --id "$hosted_zone_id" 2>&1)
aws_exit_code=$?

if [ $aws_exit_code -ne 0 ]; then
  echo "âŒ Failed to fetch Route 53 hosted zone '$hosted_zone_id'" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Invalid hosted zone ID" >&2
  echo "   - Insufficient Route 53 permissions" >&2
  echo "   - Hosted zone was deleted" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Verify hosted_public_zone_id in cloud-provider context" >&2
  echo "   - Ensure the agent has route53:GetHostedZone permission" >&2
  echo "   - AWS error: $aws_output" >&2
  SCOPE_DOMAIN=""
  export SCOPE_DOMAIN
  exit 0
fi

domain=$(echo "$aws_output" | jq -r '.HostedZone.Name' | sed 's/\.$//')

if [ -z "$domain" ] || [ "$domain" = "null" ]; then
  echo "âŒ Could not extract domain name from hosted zone response" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Hosted zone has no Name field" >&2
  echo "   - Unexpected API response format" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Verify hosted zone '$hosted_zone_id' is correctly configured in AWS" >&2
  SCOPE_DOMAIN=""
  export SCOPE_DOMAIN
  exit 0
fi

echo "   ðŸ“‹ base_domain=$domain"

# Generate subdomain
use_account_slug="${USE_ACCOUNT_SLUG:-true}"

if [ "$use_account_slug" = "true" ]; then
  subdomain="${NAMESPACE_SLUG}-${APPLICATION_SLUG}-${SCOPE_SLUG}.${ACCOUNT_SLUG}"
else
  subdomain="${NAMESPACE_SLUG}-${APPLICATION_SLUG}-${SCOPE_SLUG}"
fi

echo "   ðŸ“‹ subdomain=$subdomain"

# Full domain
SCOPE_DOMAIN="${subdomain}.${domain}"
echo "   ðŸ“‹ full_domain=$SCOPE_DOMAIN"

# Domain validation (warn but don't fail)
echo ""
echo "   ðŸ” Validating domain..."

domain_length=${#SCOPE_DOMAIN}
if [ "$domain_length" -gt 253 ]; then
  echo "   âš ï¸ WARNING: Domain length ($domain_length chars) exceeds DNS maximum of 253 characters" >&2
fi

# Check each label length (max 63 chars per label)
IFS='.' read -ra labels <<< "$SCOPE_DOMAIN"
for label in "${labels[@]}"; do
  label_length=${#label}
  if [ "$label_length" -gt 63 ]; then
    echo "   âš ï¸ WARNING: Label '$label' ($label_length chars) exceeds DNS maximum of 63 characters per label" >&2
  fi
done

# Check for invalid DNS characters
if echo "$SCOPE_DOMAIN" | grep -qE '[^a-zA-Z0-9.\-]'; then
  echo "   âš ï¸ WARNING: Domain '$SCOPE_DOMAIN' contains characters outside valid DNS range (a-z, 0-9, -, .)" >&2
fi

# Update scope with domain
echo ""
echo "   ðŸ“¡ Updating scope domain..."

np_output=$(np scope patch --id "$SCOPE_ID" --body "{\"domain\":\"$SCOPE_DOMAIN\"}" --format json 2>&1)
np_exit_code=$?

if [ $np_exit_code -ne 0 ]; then
  echo "âŒ Failed to update scope domain in nullplatform" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - nullplatform API is unavailable" >&2
  echo "   - Invalid scope ID: $SCOPE_ID" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Check nullplatform API connectivity" >&2
  echo "   - API error: $np_output" >&2
  # Don't fail - domain is optional
else
  echo "   âœ… Scope domain updated in nullplatform"
fi

export SCOPE_DOMAIN

echo ""
echo "âœ¨ Domain generation complete: domain=$SCOPE_DOMAIN"
