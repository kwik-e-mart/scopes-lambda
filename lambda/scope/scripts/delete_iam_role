#!/bin/bash
# Delete IAM role during scope deletion
# Only deletes if using dedicated role

echo "ðŸ” Cleaning up IAM role..."

# Read role info from NRN
nrn_output=$(np nrn read --nrn "$SCOPE_NRN" --namespace aws --format json 2>&1 || echo "{}")

role_name=$(echo "$nrn_output" | jq -r '.AWS_DEDICATED_ROLE_NAME // ""')
use_dedicated_role=$(echo "$nrn_output" | jq -r '.AWS_LAMBDA_USE_DEDICATED_ROLE // "false"')
role_entity=$(echo "$nrn_output" | jq -r '.AWS_LAMBDA_DEDICATED_ROLE_ENTITY // "scope"')

echo "   ðŸ“‹ use_dedicated_role=$use_dedicated_role, role_entity=$role_entity, role_name=$role_name"

if [ "$use_dedicated_role" != "true" ]; then
  echo "   âœ… Not using dedicated role - skipping IAM cleanup"
  exit 0
fi

if [ "$role_entity" != "scope" ]; then
  echo "   âœ… Role entity is '$role_entity' (not scope-level) - skipping deletion"
  exit 0
fi

if [ -z "$role_name" ] || [ "$role_name" = "null" ]; then
  echo "   âœ… No role name found in NRN - skipping IAM cleanup"
  exit 0
fi

# Check if role exists
echo ""
echo "   ðŸ“¡ Checking if role '$role_name' exists..."

existing_role=$(aws iam get-role --role-name "$role_name" 2>&1 || echo "NOT_FOUND")

if echo "$existing_role" | grep -q "NoSuchEntity\|NOT_FOUND"; then
  echo "   âœ… Role '$role_name' does not exist - skipping deletion"
  exit 0
fi

# Detach managed policies
echo ""
echo "   ðŸ“ Detaching managed policies from '$role_name'..."

attached_policies=$(aws iam list-attached-role-policies \
  --role-name "$role_name" \
  --query 'AttachedPolicies[].PolicyArn' \
  --output text 2>/dev/null || echo "")

for policy_arn in $attached_policies; do
  echo "   ðŸ“ Detaching: $policy_arn"
  aws iam detach-role-policy \
    --role-name "$role_name" \
    --policy-arn "$policy_arn" \
    2>/dev/null || true
done

# Delete inline policies
echo ""
echo "   ðŸ“ Deleting inline policies from '$role_name'..."

inline_policies=$(aws iam list-role-policies \
  --role-name "$role_name" \
  --query 'PolicyNames[]' \
  --output text 2>/dev/null || echo "")

for policy_name in $inline_policies; do
  echo "   ðŸ“ Deleting inline policy: $policy_name"
  aws iam delete-role-policy \
    --role-name "$role_name" \
    --policy-name "$policy_name" \
    2>/dev/null || true
done

# Delete the role
echo ""
echo "   ðŸ“¡ Deleting IAM role '$role_name'..."

delete_output=$(aws iam delete-role --role-name "$role_name" 2>&1)
delete_exit_code=$?

if [ $delete_exit_code -ne 0 ]; then
  echo "âŒ Failed to delete IAM role '$role_name'" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - Role still has instance profiles attached" >&2
  echo "   - Insufficient IAM permissions" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Remove all instance profiles from the role first" >&2
  echo "   - Verify the agent has iam:DeleteRole permission" >&2
  echo "   - AWS error: $delete_output" >&2
  exit 1
fi

echo "   âœ… IAM role '$role_name' deleted successfully"
echo ""
echo "âœ¨ IAM cleanup complete"
