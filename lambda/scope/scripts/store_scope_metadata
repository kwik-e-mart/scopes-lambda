#!/bin/bash
# Store Lambda scope metadata in NRN
# This persists all scope-level Lambda information

echo "ðŸ” Storing scope metadata in NRN..."

# Build metadata object
metadata="{}"

# Required fields
if [ -n "${LAMBDA_FUNCTION_NAME:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg fn "$LAMBDA_FUNCTION_NAME" \
    '. + {LAMBDA_FUNCTION_NAME: $fn}')
  echo "   ðŸ“‹ function_name=$LAMBDA_FUNCTION_NAME"
fi

if [ -n "${LAMBDA_FUNCTION_ARN:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg arn "$LAMBDA_FUNCTION_ARN" \
    '. + {LAMBDA_FUNCTION_ARN: $arn}')
  echo "   ðŸ“‹ function_arn=$LAMBDA_FUNCTION_ARN"
fi

if [ -n "${LAMBDA_ROLE_ARN:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg role "$LAMBDA_ROLE_ARN" \
    '. + {LAMBDA_ROLE_ARN: $role}')
  echo "   ðŸ“‹ role_arn=$LAMBDA_ROLE_ARN"
fi

if [ -n "${LAMBDA_ROLE_NAME:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg name "$LAMBDA_ROLE_NAME" \
    '. + {AWS_DEDICATED_ROLE_NAME: $name}')
  echo "   ðŸ“‹ role_name=$LAMBDA_ROLE_NAME"
fi

alias_name="${LAMBDA_MAIN_ALIAS_NAME:-main}"
metadata=$(echo "$metadata" | jq \
  --arg alias "$alias_name" \
  '. + {LAMBDA_FUNCTION_MAIN_ALIAS: $alias}')
echo "   ðŸ“‹ main_alias=$alias_name"

if [ -n "${SCOPE_DOMAIN:-}" ]; then
  metadata=$(echo "$metadata" | jq \
    --arg domain "$SCOPE_DOMAIN" \
    '. + {SCOPE_DOMAIN: $domain}')
  echo "   ðŸ“‹ scope_domain=$SCOPE_DOMAIN"
fi

# Write to NRN
echo ""
echo "   ðŸ“¡ Writing metadata to NRN (scope_nrn=$SCOPE_NRN, namespace=aws)..."

np_output=$(np nrn write \
  --nrn "$SCOPE_NRN" \
  --namespace aws \
  --body "$metadata" \
  --format json 2>&1)
np_exit_code=$?

if [ $np_exit_code -ne 0 ]; then
  echo "âŒ Failed to write scope metadata to NRN" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - nullplatform API is unavailable" >&2
  echo "   - Invalid SCOPE_NRN: $SCOPE_NRN" >&2
  echo "   - Malformed metadata JSON" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Check nullplatform API connectivity" >&2
  echo "   - Verify the NRN path is correct" >&2
  echo "   - API error: $np_output" >&2
  exit 1
fi

echo "   âœ… Metadata stored successfully"
echo ""
echo "âœ¨ Scope metadata saved to NRN"
