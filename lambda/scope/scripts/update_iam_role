#!/bin/bash
# Update IAM role for Lambda scope
# Called when scope capabilities change (e.g., VPC enabled/disabled)

echo "ðŸ” Updating IAM role configuration..."

# Read existing role info from NRN
nrn_output=$(np nrn read --nrn "$SCOPE_NRN" --namespace aws --format json 2>&1 || echo "{}")

role_name=$(echo "$nrn_output" | jq -r '.AWS_DEDICATED_ROLE_NAME // ""')
use_dedicated_role=$(echo "$nrn_output" | jq -r '.AWS_LAMBDA_USE_DEDICATED_ROLE // "false"')

echo "   ðŸ“‹ use_dedicated_role=$use_dedicated_role, role_name=$role_name"

if [ "$use_dedicated_role" != "true" ] || [ -z "$role_name" ] || [ "$role_name" = "null" ]; then
  echo "   âœ… Not using dedicated role - no updates needed"
  exit 0
fi

# Check if VPC status changed
vpc_enabled=$(echo "$CONTEXT" | jq -r '.scope.capabilities.vpc_enabled // false')
echo "   ðŸ“‹ vpc_enabled=$vpc_enabled"

# Check current VPC policy attachment
echo ""
echo "   ðŸ“¡ Checking current VPC policy state for role '$role_name'..."

vpc_policy_attached=$(aws iam list-attached-role-policies \
  --role-name "$role_name" \
  --query "AttachedPolicies[?PolicyArn=='arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole'].PolicyArn" \
  --output text 2>/dev/null || echo "")

if [ "$vpc_enabled" = "true" ] && [ -z "$vpc_policy_attached" ]; then
  echo "   ðŸ“ Attaching VPC access policy to '$role_name'..."

  attach_output=$(aws iam attach-role-policy \
    --role-name "$role_name" \
    --policy-arn "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole" \
    2>&1)
  attach_exit_code=$?

  if [ $attach_exit_code -ne 0 ]; then
    echo "âŒ Failed to attach VPC access policy to '$role_name'" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Insufficient IAM permissions" >&2
    echo "   - Role '$role_name' no longer exists" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Verify the agent has iam:AttachRolePolicy permission" >&2
    echo "   - Check that role '$role_name' exists in IAM" >&2
    echo "   - AWS error: $attach_output" >&2
    exit 1
  fi

  echo "   âœ… VPC access policy attached to '$role_name'"

elif [ "$vpc_enabled" = "false" ] && [ -n "$vpc_policy_attached" ]; then
  echo "   ðŸ“ Detaching VPC access policy from '$role_name'..."

  detach_output=$(aws iam detach-role-policy \
    --role-name "$role_name" \
    --policy-arn "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole" \
    2>&1)
  detach_exit_code=$?

  if [ $detach_exit_code -ne 0 ]; then
    echo "âŒ Failed to detach VPC access policy from '$role_name'" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Insufficient IAM permissions" >&2
    echo "   - Policy was already detached" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Verify the agent has iam:DetachRolePolicy permission" >&2
    echo "   - AWS error: $detach_output" >&2
    exit 1
  fi

  echo "   âœ… VPC access policy detached from '$role_name'"

else
  echo "   âœ… No VPC policy changes needed (vpc_enabled=$vpc_enabled, policy_attached=$([ -n "$vpc_policy_attached" ] && echo 'true' || echo 'false'))"
fi

echo ""
echo "âœ¨ IAM role update complete for role '$role_name'"
