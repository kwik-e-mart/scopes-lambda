#!/bin/bash
# Create IAM role for Lambda execution during scope creation
# This ensures the role is available for the placeholder Lambda

echo "ðŸ” Setting up IAM role for Lambda..."

echo ""
echo "   ðŸ“¡ Checking IAM configuration from NRN..."

use_dedicated_role="false"
role_name_template=""
role_policies="[]"
existing_role_arn=""
existing_role_name=""

nrn_output=$(np nrn read --nrn "$SCOPE_NRN" --namespace aws --format json 2>&1 || echo "{}")

if [ "$nrn_output" != "{}" ]; then
  use_dedicated_role=$(echo "$nrn_output" | jq -r '.AWS_LAMBDA_USE_DEDICATED_ROLE // "false"')
  role_name_template=$(echo "$nrn_output" | jq -r '.AWS_LAMBDA_DEDICATED_ROLE_NAME_TEMPLATE // ""')
  role_policies=$(echo "$nrn_output" | jq -r '.AWS_LAMBDA_DEDICATED_ROLE_POLICIES // "[]"')
  existing_role_arn=$(echo "$nrn_output" | jq -r '.AWS_DEDICATED_ROLE_ARN // ""')
  existing_role_name=$(echo "$nrn_output" | jq -r '.AWS_DEDICATED_ROLE_NAME // ""')
fi

echo "   ðŸ“‹ use_dedicated_role=$use_dedicated_role"

# If using existing role from NRN
if [ -n "$existing_role_arn" ] && [ "$existing_role_arn" != "null" ] && [ "$existing_role_arn" != "" ]; then
  echo "   âœ… Using existing dedicated role: $existing_role_arn"
  LAMBDA_ROLE_ARN="$existing_role_arn"
  LAMBDA_ROLE_NAME="$existing_role_name"
  export LAMBDA_ROLE_ARN
  export LAMBDA_ROLE_NAME
  exit 0
fi

# If not using dedicated role, check for default role in context
if [ "$use_dedicated_role" != "true" ]; then
  default_role=$(echo "$CONTEXT" | jq -r '.providers["cloud-providers"].lambda.execution_role_arn // empty')

  if [ -n "$default_role" ] && [ "$default_role" != "null" ]; then
    echo "   âœ… Using default execution role: $default_role"
    LAMBDA_ROLE_ARN="$default_role"
    export LAMBDA_ROLE_ARN
    exit 0
  fi

  echo "âŒ No Lambda execution role configured" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - No dedicated role enabled via NRN configuration" >&2
  echo "   - No default execution_role_arn set in cloud-provider context" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Enable dedicated roles by setting AWS_LAMBDA_USE_DEDICATED_ROLE=true in NRN" >&2
  echo "   - Or configure lambda.execution_role_arn in cloud-provider" >&2
  exit 1
fi

# Create dedicated role
echo ""
echo "   ðŸ“ Creating dedicated IAM role..."

# Generate role name from template
iam_role_name="$role_name_template"
iam_role_name="${iam_role_name//\{scope_id\}/$SCOPE_ID}"
iam_role_name="${iam_role_name//\{scope_slug\}/$SCOPE_SLUG}"
iam_role_name="${iam_role_name//\{namespace_slug\}/$NAMESPACE_SLUG}"
iam_role_name="${iam_role_name//\{application_slug\}/$APPLICATION_SLUG}"
iam_role_name="${iam_role_name//\{account_slug\}/$ACCOUNT_SLUG}"
iam_role_name="${iam_role_name:0:64}"

echo "   ðŸ“‹ role_name=$iam_role_name"

# Check if role already exists
existing_role=$(aws iam get-role --role-name "$iam_role_name" 2>&1 || echo "NOT_FOUND")

if ! echo "$existing_role" | grep -q "NoSuchEntity\|NOT_FOUND"; then
  echo "   âœ… Role already exists, reusing it"
  LAMBDA_ROLE_ARN=$(echo "$existing_role" | jq -r '.Role.Arn')
  LAMBDA_ROLE_NAME="$iam_role_name"
else
  # Create trust policy for Lambda
  trust_policy='{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {
          "Service": "lambda.amazonaws.com"
        },
        "Action": "sts:AssumeRole"
      }
    ]
  }'

  # Create the role
  create_output=$(aws iam create-role \
    --role-name "$iam_role_name" \
    --assume-role-policy-document "$trust_policy" \
    --description "Lambda execution role for $SCOPE_SLUG" \
    2>&1)
  create_exit_code=$?

  if [ $create_exit_code -ne 0 ]; then
    echo "âŒ Failed to create IAM role '$iam_role_name'" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Insufficient IAM permissions to create roles" >&2
    echo "   - Role name conflicts with an existing role in a different state" >&2
    echo "   - AWS API rate limiting or service issues" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Verify the agent has iam:CreateRole permission" >&2
    echo "   - Check AWS CloudTrail for detailed error information" >&2
    echo "   - AWS error: $create_output" >&2
    exit 1
  fi

  LAMBDA_ROLE_ARN=$(echo "$create_output" | jq -r '.Role.Arn')
  LAMBDA_ROLE_NAME="$iam_role_name"

  echo "   âœ… Role created: $LAMBDA_ROLE_ARN"

  # Attach basic Lambda execution policy
  attach_output=$(aws iam attach-role-policy \
    --role-name "$iam_role_name" \
    --policy-arn "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole" \
    2>&1)
  attach_exit_code=$?

  if [ $attach_exit_code -ne 0 ]; then
    echo "âŒ Failed to attach AWSLambdaBasicExecutionRole to '$iam_role_name'" >&2
    echo "ðŸ’¡ Possible causes:" >&2
    echo "   - Insufficient IAM permissions to attach policies" >&2
    echo "   - Policy ARN not found in this partition" >&2
    echo "ðŸ”§ How to fix:" >&2
    echo "   - Verify the agent has iam:AttachRolePolicy permission" >&2
    echo "   - AWS error: $attach_output" >&2
    exit 1
  fi

  echo "   âœ… Attached AWSLambdaBasicExecutionRole"

  # Check if VPC is enabled - attach VPC policy
  vpc_enabled=$(echo "$CONTEXT" | jq -r '.scope.capabilities.vpc_enabled // false')
  if [ "$vpc_enabled" = "true" ]; then
    vpc_attach_output=$(aws iam attach-role-policy \
      --role-name "$iam_role_name" \
      --policy-arn "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole" \
      2>&1)
    vpc_attach_exit_code=$?

    if [ $vpc_attach_exit_code -ne 0 ]; then
      echo "âŒ Failed to attach AWSLambdaVPCAccessExecutionRole to '$iam_role_name'" >&2
      echo "ðŸ’¡ Possible causes:" >&2
      echo "   - Insufficient IAM permissions" >&2
      echo "ðŸ”§ How to fix:" >&2
      echo "   - Verify the agent has iam:AttachRolePolicy permission" >&2
      echo "   - AWS error: $vpc_attach_output" >&2
      exit 1
    fi

    echo "   âœ… Attached AWSLambdaVPCAccessExecutionRole (vpc_enabled=$vpc_enabled)"
  fi

  # Attach custom policies from NRN
  if [ "$role_policies" != "[]" ] && [ "$role_policies" != "null" ]; then
    policy_count=$(echo "$role_policies" | jq length)
    echo "   ðŸ“ Attaching $policy_count custom policies..."

    for i in $(seq 0 $((policy_count - 1))); do
      policy_name=$(echo "$role_policies" | jq -r ".[$i].name")
      policy_document=$(echo "$role_policies" | jq -r ".[$i].policy")

      put_output=$(aws iam put-role-policy \
        --role-name "$iam_role_name" \
        --policy-name "$policy_name" \
        --policy-document "$policy_document" \
        2>&1)
      put_exit_code=$?

      if [ $put_exit_code -ne 0 ]; then
        echo "âŒ Failed to attach custom policy '$policy_name' to '$iam_role_name'" >&2
        echo "ðŸ’¡ Possible causes:" >&2
        echo "   - Invalid policy document JSON" >&2
        echo "   - Insufficient IAM permissions" >&2
        echo "ðŸ”§ How to fix:" >&2
        echo "   - Validate the policy document in AWS_LAMBDA_DEDICATED_ROLE_POLICIES NRN key" >&2
        echo "   - AWS error: $put_output" >&2
        exit 1
      fi

      echo "   âœ… Attached custom policy: $policy_name"
    done
  fi
fi

# Store role info in NRN
echo ""
echo "   ðŸ“¡ Storing role info in NRN..."

nrn_write_output=$(np nrn write \
  --nrn "$SCOPE_NRN" \
  --namespace aws \
  --body "{\"AWS_DEDICATED_ROLE_ARN\": \"$LAMBDA_ROLE_ARN\", \"AWS_DEDICATED_ROLE_NAME\": \"$LAMBDA_ROLE_NAME\"}" \
  --format json 2>&1)
nrn_write_exit_code=$?

if [ $nrn_write_exit_code -ne 0 ]; then
  echo "âŒ Failed to store role info in NRN" >&2
  echo "ðŸ’¡ Possible causes:" >&2
  echo "   - NRN service unavailable" >&2
  echo "   - Invalid SCOPE_NRN: $SCOPE_NRN" >&2
  echo "ðŸ”§ How to fix:" >&2
  echo "   - Check nullplatform API connectivity" >&2
  echo "   - NRN error: $nrn_write_output" >&2
  exit 1
fi

# Export variables
export LAMBDA_ROLE_ARN
export LAMBDA_ROLE_NAME

echo ""
echo "âœ¨ IAM role setup complete: role_arn=$LAMBDA_ROLE_ARN"
